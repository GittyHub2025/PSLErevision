<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PSLE 华文闪卡 (PSLE Chinese Flashcards)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }

        .correct-state-static {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
        }
        .correct-state-static #questionText { display: none !important; }
        .correct-state-static #feedbackText,
        .correct-state-static #feedbackIconContainer { color: white !important; }

        .incorrect-state {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #b91c1c !important; /* red-700 */
        }
        .incorrect-state #questionText { display: none !important; }
        .incorrect-state #feedbackText,
        .incorrect-state #feedbackIconContainer { color: white !important; }

        /* NEW: Styles for enhanced incorrect answer feedback */
        .annotated-sentence-container {
            font-size: 1.5rem; /* Large font for the sentence */
            font-weight: 600;
            line-height: 2.5;
            margin-bottom: 1rem;
            color: white;
            background-color: rgba(0, 0, 0, 0.15);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .word-anno {
            display: inline-block;
            text-align: center;
            margin: 0 0.25rem;
            padding: 0 0.1rem;
        }
        .word-anno .pinyin {
            display: block;
            font-size: 0.9rem;
            font-weight: 400;
            color: #fce7f3; /* A lighter pink/white for pinyin */
        }
        .english-explanation {
            font-style: italic;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: white;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 0.375rem;
        }
        .explanation-box {
            font-size: 0.9rem;
            display: block;
            margin-top: 0.5rem;
            font-weight: normal;
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.5rem; border-radius: 0.375rem;
        }
        .prompt-guidance {
             font-size: 0.875rem; display: block; margin-top: 1rem; font-weight: bold;
        }

        .choice-button, .action-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border-radius: 0.5rem; font-weight: 600;
            padding: 0.75rem 0.5rem; text-align: center;
            border: 1px solid transparent;
        }
        .choice-button:hover:not(:disabled), .action-button:hover {
            transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        .choice-button:active:not(:disabled), .action-button:active {
            transform: translateY(0px); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .choice-button:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .choice-button.forced-disabled-look { opacity: 0.5; }
        .choice-button:disabled:hover { transform: none; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }

        .clickable-card { cursor: pointer; }
        #progressBarFill { transition: width 0.3s ease-out; }
        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .race-track-container { position: relative; width: 100%; height: 30px; margin-top: 20px; margin-bottom: 20px; z-index: 1; }
        .race-track { position: absolute; bottom: 0; left: 0; width: calc(100% - 30px); height: 10px; background-color: #d1d5db; border-radius: 5px; z-index: 2; }
        .race-track-fill { position: absolute; bottom: 0; left: 0; height: 10px; background-color: #3b82f6; border-radius: 5px; width: 0%; z-index: 3; transition: width 1.5s ease-out; }
        .rocket { position: absolute; bottom: -8px; left: 0; font-size: 36px; transform: translateX(-50%); z-index: 10; transition: left 1.5s ease-out; }
        .checkered-flag { position: absolute; bottom: -8px; right: 0; font-size: 24px; transform: translateX(50%); z-index: 10; }

        #questionText { word-break: break-word; hyphens: auto; }
        .choice-button { white-space: normal; word-break: break-word; line-height: 1.4; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        
        /* IMPROVEMENT: Bigger text for questions and choices */
        #questionText {
            font-size: 1.75rem; /* was text-2xl */
        }
        @media (min-width: 768px) {
            #questionText {
                font-size: 2rem; /* was md:text-3xl */
            }
        }
        .choice-button {
            font-size: 1.125rem; /* was text-base */
        }
        @media (min-width: 768px) {
            .choice-button {
                font-size: 1.25rem; /* was md:text-lg */
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-rose-100 via-amber-100 to-orange-100 min-h-screen flex items-center justify-center p-4">

    <div id="appContainer" class="w-full max-w-md mx-auto">

        <!-- Name Input Modal -->
         <div id="nameModal" class="modal">
             <div class="modal-content text-center">
                 <h2 class="text-xl md:text-2xl font-semibold mb-4 text-red-700">欢迎，华文学习者！</h2>
                 <p class="text-slate-600 mb-4">请输入你的名字，开始你的PSLE华文复习之旅。</p>
                 <input type="text" id="userNameInput" placeholder="你的名字" class="w-full p-2 border border-slate-300 rounded mb-4 focus:ring-red-500 focus:border-red-500 text-center text-lg">
                 <button onclick="saveUserName()" class="action-button bg-red-500 hover:bg-red-600 text-white w-full py-3 px-6 text-lg">开始学习！</button>
             </div>
         </div>

        <!-- Set Selection Screen -->
        <div id="setSelectionScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-red-800 mb-2">PSLE 华文练习</h1>
            <p class="text-slate-600 mb-8">请选择一个题组来巩固你的知识！</p>
            <div id="setButtonsContainer" class="grid grid-cols-1 gap-4">
                <!-- Buttons for flashcard sets will be dynamically added here by JS -->
            </div>
        </div>

        <!-- Flashcard Screen -->
        <div id="flashcardScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-slate-600">进度</span>
                    <span id="progressText" class="text-sm font-medium text-red-700">0 / 0</span> </div>
                <div class="w-full bg-slate-200 rounded-full h-2.5">
                    <div id="progressBarFill" class="bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="flashcard" class="bg-white border border-slate-300 rounded-lg p-6 mb-6 text-center min-h-[200px] flex flex-col items-center justify-center transition-colors duration-300">
                 <div id="flashcardContent" class="w-full flex flex-col items-center justify-center">
                     <div id="feedbackIconContainer" class="hidden text-7xl md:text-8xl mb-2"></div>
                     <p id="questionText" class="font-semibold text-slate-800"></p>
                     <div id="feedbackText" class="mt-2 text-base md:text-lg font-semibold"></div>
                     <p id="continueText" class="mt-4 text-sm text-slate-500 hidden">点击卡片继续...</p>
                 </div>
            </div>

            <div id="answerChoices" class="grid grid-cols-1 gap-3 md:gap-4">
                <button id="choice1" class="choice-button bg-slate-100 hover:bg-slate-200 text-slate-700"></button>
                <button id="choice2" class="choice-button bg-slate-100 hover:bg-slate-200 text-slate-700"></button>
                <button id="choice3" class="choice-button bg-slate-100 hover:bg-slate-200 text-slate-700"></button>
            </div>
             <button onclick="showSetSelection()" class="action-button mt-6 bg-slate-500 hover:bg-slate-600 text-white w-full text-sm py-3 px-6">返回选题</button>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
            <h2 id="resultsHeading" class="text-2xl md:text-3xl font-bold text-red-700 mb-4"></h2>
            <div class="bg-emerald-500 text-white p-4 rounded-lg mb-6">
                <p class="text-lg md:text-xl font-semibold mb-1">你的分数:</p>
                <p id="scoreDisplay" class="text-4xl md:text-5xl font-bold italic"></p>
            </div>
            <div class="race-track-container">
                <div class="race-track"></div>
                <div id="raceTrackFill" class="race-track-fill bg-red-500"></div>
                <span id="rocketEl" class="rocket">🚀</span>
                <span id="checkeredFlag" class="checkered-flag">🏁</span>
            </div>
            <p class="text-lg text-slate-700 mb-2">正确率: <span id="percentage" class="font-semibold"></span>%</p>
            <p class="text-lg text-slate-700 mb-6">用时: <span id="timeTaken" class="font-semibold"></span> 秒</p>
            <p id="encouragementText" class="text-lg text-red-700 font-semibold mb-6"></p>
            <div id="incorrectListContainer" class="mb-6 text-left">
                <h3 class="text-xl font-semibold text-red-600 mb-3">复习错题:</h3>
                <ul id="incorrectList" class="list-disc list-inside space-y-2 text-slate-600 text-sm"></ul>
                 <p id="noIncorrectText" class="text-emerald-600 font-semibold hidden">太棒了，没有错题！</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="redoIncorrectButton" onclick="redoIncorrect()" class="action-button bg-orange-500 hover:bg-orange-600 text-white w-full py-3 px-6">重做错题</button>
                <button onclick="showSetSelection()" class="action-button bg-red-500 hover:bg-red-600 text-white w-full py-3 px-6">选择其他题组</button>
            </div>
        </div>
    </div>
    <canvas id="confettiCanvas"></canvas>

   <script>
    // --- Configuration ---
    const QUESTIONS_PER_SET = 20;
    const AUTO_PROCEED_DELAY = 1800;
    const USER_NAME_STORAGE_KEY = 'psleChineseApp_v2_improved';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxl5mcaKKp3rXABfN6tMDqzUMCZ7eUTUt3LeoO8xFlwlSTuJqbOMY9vNxwSatucjec/exec';

    // --- NEW FLASHCARD SETS (IMPROVED) ---
    const allFlashcardSets = {
        "第一组：词语认读 (Easy)": [
            { id: 'c1q1', question: "“拨打” 的拼音是什么？", options: ["bō dǎ", "bá dǎ", "pō dǎ"], correctAnswer: "bō dǎ", explanation: "“拨打” (bō dǎ) 指按电话号码呼叫，如“拨打电话”。", annotatedSentence: `<div class="word-anno">拨打<span class="pinyin">bō dǎ</span></div>`, englishExplanation: "English: '拨' (bō) means to dial or push aside. Combined with '打' (dǎ), '拨打' (bō dǎ) specifically means to dial a phone." },
            { id: 'c1q2', question: "“歪斜” 的意思是什么？", options: ["整齐", "不正，偏离中心", "笔直"], correctAnswer: "不正，偏离中心", explanation: "“歪斜” (wāi xié) 形容物体不正或倾斜。", annotatedSentence: `<div class="word-anno">歪斜<span class="pinyin">wāi xié</span></div>`, englishExplanation: "English: '歪' (wāi) means askew, and '斜' (xié) means slanted. Together, '歪斜' (wāi xié) describes something that is crooked or tilted." },
            { id: 'c1q3', question: "“踩踏” 的拼音是什么？", options: ["cǎi tà", "chǎi tà", "cǎi dà"], correctAnswer: "cǎi tà", explanation: "“踩踏” (cǎi tà) 指用力地踩，如“请勿踩踏草地”。", annotatedSentence: `<div class="word-anno">踩踏<span class="pinyin">cǎi tà</span></div>`, englishExplanation: "English: '踩' (cǎi) means to step on, and '踏' (tà) also means to step. '踩踏' (cǎi tà) implies repeated or heavy stepping, i.e., to trample." },
            { id: 'c1q4', question: "“牵引” 的意思是什么？", options: ["推开", "拉着向前", "停止"], correctAnswer: "拉着向前", explanation: "“牵引” (qiān yǐn) 的意思是拉着物体，使它前进。", annotatedSentence: `<div class="word-anno">牵引<span class="pinyin">qiān yǐn</span></div>`, englishExplanation: "English: '牵' (qiān) is to pull and '引' (yǐn) is to guide. '牵引' (qiān yǐn) means to tow or pull something forward." },
            { id: 'c1q5', question: "“煎熬” 的拼音是什么？", options: ["jiān áo", "qián áo", "jiān āo"], correctAnswer: "jiān áo", explanation: "“煎熬” (jiān áo) 比喻焦虑、痛苦的折磨。", annotatedSentence: `<div class="word-anno">煎熬<span class="pinyin">jiān áo</span></div>`, englishExplanation: "English: While '煎' (jiān) means to pan-fry, '煎熬' (jiān áo) is a metaphor for suffering or torment, like being slowly cooked." },
            { id: 'c1q6', question: "“脆弱” 的意思是什么？", options: ["坚固", "不坚强，易受伤害", "有弹性"], correctAnswer: "不坚强，易受伤害", explanation: "“脆弱” (cuì ruò) 形容不坚强，容易损坏或受到伤害。", annotatedSentence: `<div class="word-anno">脆弱<span class="pinyin">cuì ruò</span></div>`, englishExplanation: "English: '脆' (cuì) means brittle and '弱' (ruò) means weak. '脆弱' (cuì ruò) describes something or someone as fragile or vulnerable." },
            { id: 'c1q7', question: "“逛街” 的拼音是什么？", options: ["guàng jiē", "kuàng jiē", "guāng jiē"], correctAnswer: "guàng jiē", explanation: "“逛街” (guàng jiē) 是在街上闲逛、购物。", annotatedSentence: `<div class="word-anno">逛街<span class="pinyin">guàng jiē</span></div>`, englishExplanation: "English: '逛' (guàng) means to stroll or wander. '逛街' (guàng jiē) is the common term for window shopping or shopping in general." },
            { id: 'c1q8', question: "“价格” 的意思是什么？", options: ["物品的重量", "物品买卖的钱数", "物品的颜色"], correctAnswer: "物品买卖的钱数", explanation: "“价格” (jià gé) 就是一件商品值多少钱。", annotatedSentence: `<div class="word-anno">价格<span class="pinyin">jià gé</span></div>`, englishExplanation: "English: '价' (jià) relates to price and '格' (gé) relates to a standard or form. '价格' (jià gé) means price." },
            { id: 'c1q9', question: "“贪心” 的拼音是什么？", options: ["tān xīn", "tán xīn", "dān xīn"], correctAnswer: "tān xīn", explanation: "“贪心” (tān xīn) 指的是贪得无厌的欲望。", annotatedSentence: `<div class="word-anno">贪心<span class="pinyin">tān xīn</span></div>`, englishExplanation: "English: '贪' (tān) means greedy and '心' (xīn) means heart. '贪心' (tān xīn) literally translates to 'greedy heart' and means greed." },
            { id: 'c1q10', question: "“笨重” 的意思是什么？", options: ["轻便灵活", "又笨又重，不灵便", "聪明"], correctAnswer: "又笨又重，不灵便", explanation: "“笨重” (bèn zhòng) 形容物体又大又重，不易搬动；也形容人动作不灵活。", annotatedSentence: `<div class="word-anno">笨重<span class="pinyin">bèn zhòng</span></div>`, englishExplanation: "English: '笨' (bèn) means clumsy and '重' (zhòng) means heavy. '笨重' (bèn zhòng) describes something as bulky, heavy, and unwieldy." },
            { id: 'c1q11', question: "“惩罚” 的拼音是什么？", options: ["chéng fá", "chěng fá", "chéng bà"], correctAnswer: "chéng fá", explanation: "“惩罚” (chéng fá) 指对犯错误的人或事进行处罚。", annotatedSentence: `<div class="word-anno">惩罚<span class="pinyin">chéng fá</span></div>`, englishExplanation: "English: '惩' (chéng) and '罚' (fá) both mean to punish. '惩罚' (chéng fá) is the common word for punishment." },
            { id: 'c1q12', question: "“杰出” 的意思是什么？", options: ["平凡", "才能、成就出众", "害羞"], correctAnswer: "才能、成就出众", explanation: "“杰出” (jié chū) 形容人的才能或成就非常优秀、超出一般。", annotatedSentence: `<div class="word-anno">杰出<span class="pinyin">jié chū</span></div>`, englishExplanation: "English: '杰' (jié) means heroic or outstanding, and '出' (chū) means to go beyond. '杰出' (jié chū) means outstanding or distinguished." },
            { id: 'c1q13', question: "“催促” 的拼音是什么？", options: ["cuī cù", "suī cù", "tuī cù"], correctAnswer: "cuī cù", explanation: "“催促” (cuī cù) 的意思是叫人赶快行动或做事。", annotatedSentence: `<div class="word-anno">催促<span class="pinyin">cuī cù</span></div>`, englishExplanation: "English: Both '催' (cuī) and '促' (cù) mean to urge or press. '催促' (cuī cù) means to urge someone to hurry up." },
            { id: 'c1q14', question: "“腹泻” 的意思是什么？", options: ["头痛", "拉肚子", "咳嗽"], correctAnswer: "拉肚子", explanation: "“腹泻” (fù xiè) 是医学名词，就是我们平时说的“拉肚子”。", annotatedSentence: `<div class="word-anno">腹泻<span class="pinyin">fù xiè</span></div>`, englishExplanation: "English: '腹' (fù) means abdomen, and '泻' (xiè) means to flow down quickly. '腹泻' (fù xiè) is the formal term for diarrhea." },
            { id: 'c1q15', question: "“严厉” 的拼音是什么？", options: ["yán lì", "yán le", "yán nì"], correctAnswer: "yán lì", explanation: "“严厉” (yán lì) 形容态度严肃、严格，不宽容。", annotatedSentence: `<div class="word-anno">严厉<span class="pinyin">yán lì</span></div>`, englishExplanation: "English: '严' (yán) means strict, and '厉' (lì) means severe. '严厉' (yán lì) describes someone or something as strict or stern." },
            { id: 'c1q16', question: "“包含” 的意思是什么？", options: ["排除在外", "里面含有", "完全等于"], correctAnswer: "里面含有", explanation: "“包含” (bāo hán) 的意思是在里面藏着或包括着。", annotatedSentence: `<div class="word-anno">包含<span class="pinyin">bāo hán</span></div>`, englishExplanation: "English: '包' (bāo) means to wrap or include, and '含' (hán) means to contain. '包含' (bāo hán) means to contain or include." },
            { id: 'c1q17', question: "“软弱” 的拼音是什么？", options: ["ruǎn ruò", "nǎn ruò", "ruǎn nuò"], correctAnswer: "ruǎn ruò", explanation: "“软弱” (ruǎn ruò) 指身体无力，或性格不坚强。", annotatedSentence: `<div class="word-anno">软弱<span class="pinyin">ruǎn ruò</span></div>`, englishExplanation: "English: '软' (ruǎn) means soft, and '弱' (ruò) means weak. '软弱' (ruǎn ruò) describes physical weakness or a weak character." },
            { id: 'c1q18', question: "“懒惰” 的意思是什么？", options: ["勤奋努力", "不爱劳动和工作", "非常疲劳"], correctAnswer: "不爱劳动和工作", explanation: "“懒惰” (lǎn duò) 是指不勤快，不喜欢做事。", annotatedSentence: `<div class="word-anno">懒惰<span class="pinyin">lǎn duò</span></div>`, englishExplanation: "English: '懒' (lǎn) and '惰' (duò) both mean lazy. '懒惰' (lǎn duò) is the standard word for lazy or indolent." },
            { id: 'c1q19', question: "“敏捷” 的拼音是什么？", options: ["mǐn jié", "mǐn jiē", "míng jié"], correctAnswer: "mǐn jié", explanation: "“敏捷” (mǐn jié) 形容动作、思维等迅速而灵敏。", annotatedSentence: `<div class="word-anno">敏捷<span class="pinyin">mǐn jié</span></div>`, englishExplanation: "English: '敏' (mǐn) means quick/nimble, and '捷' (jié) means swift. '敏捷' (mǐn jié) means agile, nimble, or quick-witted." },
            { id: 'c1q20', question: "“质量” 的意思是什么？", options: ["物品的数量", "物品的优劣程度", "物品的重量"], correctAnswer: "物品的优劣程度", explanation: "“质量” (zhì liàng) 指的是产品或工作的品质好坏。", annotatedSentence: `<div class="word-anno">质量<span class="pinyin">zhì liàng</span></div>`, englishExplanation: "English: '质' (zhì) means quality/nature, and '量' (liàng) means quantity. '质量' (zhì liàng) specifically refers to the quality of an item." }
        ],
        "第二组：词语应用 (Medium)": [
            { id: 'c2q1', question: "看到这个好消息，大家脸上都（ ）出了笑容。", options: ["透露", "牵动", "模仿"], correctAnswer: "透露", 
              explanation: "“透露”(tòu lù) 意思是显露出来。“牵动”是拉动，“模仿”是学别人的样子。", 
              annotatedSentence: `<span class="word-anno">大家<span class="pinyin">dà jiā</span></span><span class="word-anno">脸上<span class="pinyin">liǎn shàng</span></span><span class="word-anno">都<span class="pinyin">dōu</span></span><span class="word-anno">透露<span class="pinyin">tòu lù</span></span><span class="word-anno">出<span class="pinyin">chū</span></span><span class="word-anno">了<span class="pinyin">le</span></span><span class="word-anno">笑容<span class="pinyin">xiào róng</span></span>`, 
              englishExplanation: "English: '透露' (tòu lù) means 'to reveal' or 'to show'. It fits here to describe how happiness was revealed through their smiles." },
            { id: 'c2q2', question: "妈妈做的炸鸡又香又（ ），我最喜欢吃了。", options: ["硬", "脆", "酸"], correctAnswer: "脆", 
              explanation: "“香脆”(xiāng cuì) 是形容食物可口的好词。“硬”(yìng) 是不软，“酸”(suān) 是一种味道。", 
              annotatedSentence: `<span class="word-anno">炸鸡<span class="pinyin">zhà jī</span></span><span class="word-anno">又<span class="pinyin">yòu</span></span><span class="word-anno">香<span class="pinyin">xiāng</span></span><span class="word-anno">又<span class="pinyin">yòu</span></span><span class="word-anno">脆<span class="pinyin">cuì</span></span>`, 
              englishExplanation: "English: '脆' (cuì) means 'crispy'. The phrase '又香又脆' (yòu xiāng yòu cuì - both fragrant and crispy) is a common way to describe delicious fried food." },
            { id: 'c2q3', question: "为了买到那件限量版的玩具，哥哥一大早就去商店（ ）了。", options: ["插队", "排队", "挤队"], correctAnswer: "排队", 
              explanation: "“排队”(pái duì) 是有秩序地站成一列等待。“插队”是不礼貌的行为。", 
              annotatedSentence: `<span class="word-anno">哥哥<span class="pinyin">gē ge</span></span><span class="word-anno">去<span class="pinyin">qù</span></span><span class="word-anno">商店<span class="pinyin">shāng diàn</span></span><span class="word-anno">排队<span class="pinyin">pái duì</span></span><span class="word-anno">了<span class="pinyin">le</span></span>`, 
              englishExplanation: "English: '排队' (pái duì) means 'to queue' or 'to line up', which is the expected action when waiting to buy something." },
            { id: 'c2q4', question: "这家商店的商品（ ）很公道，因此吸引了很多顾客。", options: ["价格", "价值", "假货"], correctAnswer: "价格", 
              explanation: "“价格”(jià gé) 指商品卖多少钱。“价值”是意义或作用。", 
              annotatedSentence: `<span class="word-anno">商品<span class="pinyin">shāng pǐn</span></span><span class="word-anno">价格<span class="pinyin">jià gé</span></span><span class="word-anno">很<span class="pinyin">hěn</span></span><span class="word-anno">公道<span class="pinyin">gōng dao</span></span>`, 
              englishExplanation: "English: '价格' (jià gé) means 'price'. The sentence says the price is '公道' (gōng dao - fair/reasonable), which makes sense in context." },
            { id: 'c2q5', question: "他因为不肯承认错误，所以受到了老师的（ ）。", options: ["惩罚", "奖励", "表扬"], correctAnswer: "惩罚", 
              explanation: "“惩罚”(chéng fá) 是对错误行为的处罚。“奖励”和“表扬”是对良好行为的肯定。", 
              annotatedSentence: `<span class="word-anno">受到<span class="pinyin">shòu dào</span></span><span class="word-anno">了<span class="pinyin">le</span></span><span class="word-anno">老师<span class="pinyin">lǎo shī</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">惩罚<span class="pinyin">chéng fá</span></span>`, 
              englishExplanation: "English: '惩罚' (chéng fá) means 'punishment'. It is the logical consequence of not admitting one's mistake." },
            { id: 'c2q6', question: "消防员（ ）地冲进火场救人，大家都非常敬佩他们。", options: ["勇敢", "害怕", "胆小"], correctAnswer: "勇敢", 
              explanation: "“勇敢”(yǒng gǎn) 是指不怕危险和困难。这符合消防员的行为。", 
              annotatedSentence: `<span class="word-anno">消防员<span class="pinyin">xiāo fáng yuán</span></span><span class="word-anno">勇敢<span class="pinyin">yǒng gǎn</span></span><span class="word-anno">地<span class="pinyin">de</span></span><span class="word-anno">冲进<span class="pinyin">chōng jìn</span></span><span class="word-anno">火场<span class="pinyin">huǒ chǎng</span></span>`, 
              englishExplanation: "English: '勇敢' (yǒng gǎn) means 'brave'. This word accurately describes the heroic action of firefighters rushing into a fire." },
            { id: 'c2q7', question: "在这次的比赛中，我们班（ ）了冠军。", options: ["赢得", "输掉", "失去"], correctAnswer: "赢得", 
              explanation: "“赢得”(yíng dé) 是通过努力获得胜利或好的结果。", 
              annotatedSentence: `<span class="word-anno">我们<span class="pinyin">wǒ men</span></span><span class="word-anno">班<span class="pinyin">bān</span></span><span class="word-anno">赢得<span class="pinyin">yíng dé</span></span><span class="word-anno">了<span class="pinyin">le</span></span><span class="word-anno">冠军<span class="pinyin">guàn jūn</span></span>`, 
              englishExplanation: "English: '赢得' (yíng dé) means 'to win'. It is the correct verb to use for winning a championship ('冠军')." },
            { id: 'c2q8', question: "过马路时，我们应该（ ）交通规则。", options: ["遵守", "违反", "忽略"], correctAnswer: "遵守", 
              explanation: "“遵守”(zūn shǒu) 是依照规定行动。为了安全，必须遵守交通规则。", 
              annotatedSentence: `<span class="word-anno">我们<span class="pinyin">wǒ men</span></span><span class="word-anno">应该<span class="pinyin">yīng gāi</span></span><span class="word-anno">遵守<span class="pinyin">zūn shǒu</span></span><span class="word-anno">交通<span class="pinyin">jiāo tōng</span></span><span class="word-anno">规则<span class="pinyin">guī zé</span></span>`, 
              englishExplanation: "English: '遵守' (zūn shǒu) means 'to abide by' or 'to comply with'. It is used with rules ('规则')." },
            { id: 'c2q9', question: "听了爷爷讲的故事，我心里的（ ）全都消失了。", options: ["疑惑", "问题", "麻烦"], correctAnswer: "疑惑", 
              explanation: "“疑惑”(yí huò) 是指心里不明白，有疑问。“问题”更具体，“麻烦”是困难的事。", 
              annotatedSentence: `<span class="word-anno">我<span class="pinyin">wǒ</span></span><span class="word-anno">心里<span class="pinyin">xīn lǐ</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">疑惑<span class="pinyin">yí huò</span></span><span class="word-anno">全都<span class="pinyin">quán dōu</span></span><span class="word-anno">消失<span class="pinyin">xiāo shī</span></span><span class="word-anno">了<span class="pinyin">le</span></span>`, 
              englishExplanation: "English: '疑惑' (yí huò) means 'doubt' or 'puzzlement'. It's a feeling of uncertainty that can be cleared up by a story or explanation." },
            { id: 'c2q10', question: "外面下着倾盆大雨，路人只好暂时（ ）在屋檐下。", options: ["躲避", "隐藏", "奔跑"], correctAnswer: "躲避", 
              explanation: "“躲避”(duǒ bì) 是为了不受伤害而躲开。“隐藏”是藏起来不让人发现。", 
              annotatedSentence: `<span class="word-anno">路人<span class="pinyin">lù rén</span></span><span class="word-anno">只好<span class="pinyin">zhǐ hǎo</span></span><span class="word-anno">暂时<span class="pinyin">zàn shí</span></span><span class="word-anno">躲避<span class="pinyin">duǒ bì</span></span><span class="word-anno">在<span class="pinyin">zài</span></span><span class="word-anno">屋檐<span class="pinyin">wū yán</span></span><span class="word-anno">下<span class="pinyin">xià</span></span>`, 
              englishExplanation: "English: '躲避' (duǒ bì) means 'to take shelter' or 'to dodge'. It's the right action for people avoiding a heavy downpour." },
            { id: 'c2q11', question: "医生仔细地为病人（ ），希望能找出病因。", options: ["检查", "治疗", "看望"], correctAnswer: "检查", 
              explanation: "“检查”(jiǎn chá) 是为了了解情况而查看。“治疗”是在检查之后进行的。", 
              annotatedSentence: `<span class="word-anno">医生<span class="pinyin">yī shēng</span></span><span class="word-anno">为<span class="pinyin">wèi</span></span><span class="word-anno">病人<span class="pinyin">bìng rén</span></span><span class="word-anno">检查<span class="pinyin">jiǎn chá</span></span>`, 
              englishExplanation: "English: '检查' (jiǎn chá) means 'to examine' or 'to check'. A doctor examines a patient to find the cause ('病因') of an illness." },
            { id: 'c2q12', question: "我们要养成（ ）的好习惯，不浪费资源。", options: ["勤劳", "勤快", "勤俭"], correctAnswer: "勤俭", 
              explanation: "“勤俭”(qín jiǎn) 指既勤劳又节约。“勤劳”和“勤快”只强调不懒惰。", 
              annotatedSentence: `<span class="word-anno">养成<span class="pinyin">yǎng chéng</span></span><span class="word-anno">勤俭<span class="pinyin">qín jiǎn</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">好<span class="pinyin">hǎo</span></span><span class="word-anno">习惯<span class="pinyin">xí guàn</span></span>`, 
              englishExplanation: "English: '勤俭' (qín jiǎn) means 'diligent and frugal'. It's the most precise word as the sentence mentions both forming a good habit and not wasting resources." },
            { id: 'c2q13', question: "他是个（ ）的孩子，从不说谎。", options: ["诚实", "虚假", "狡猾"], correctAnswer: "诚实", 
              explanation: "“诚实”(chéng shí) 指的是不说谎，不骗人。", 
              annotatedSentence: `<span class="word-anno">他<span class="pinyin">tā</span></span><span class="word-anno">是<span class="pinyin">shì</span></span><span class="word-anno">个<span class="pinyin">gè</span></span><span class="word-anno">诚实<span class="pinyin">chéng shí</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">孩子<span class="pinyin">hái zi</span></span>`, 
              englishExplanation: "English: '诚实' (chéng shí) means 'honest'. The clue '从不说谎' (cóng bù shuō huǎng - never tells lies) directly points to this answer." },
            { id: 'c2q14', question: "姐姐的钢琴表演非常（ ），获得了观众热烈的掌声。", options: ["成功", "胜利", "完成"], correctAnswer: "成功", 
              explanation: "“成功”(chéng gōng) 形容事情达到了预期的好结果。“胜利”多用于比赛或战争。", 
              annotatedSentence: `<span class="word-anno">钢琴<span class="pinyin">gāng qín</span></span><span class="word-anno">表演<span class="pinyin">biǎo yǎn</span></span><span class="word-anno">非常<span class="pinyin">fēi cháng</span></span><span class="word-anno">成功<span class="pinyin">chéng gōng</span></span>`, 
              englishExplanation: "English: '成功' (chéng gōng) means 'successful'. It is used to describe an event or performance that went very well, as indicated by the applause." },
            { id: 'c2q15', question: "为了保护环境，我们应该（ ）使用塑料袋。", options: ["增加", "减少", "停止"], correctAnswer: "减少", 
              explanation: "“减少”(jiǎn shǎo) 使用是环保的有效方法。“停止”使用可能不现实，但减少是可行的。", 
              annotatedSentence: `<span class="word-anno">我们<span class="pinyin">wǒ men</span></span><span class="word-anno">应该<span class="pinyin">yīng gāi</span></span><span class="word-anno">减少<span class="pinyin">jiǎn shǎo</span></span><span class="word-anno">使用<span class="pinyin">shǐ yòng</span></span><span class="word-anno">塑料袋<span class="pinyin">sù liào dài</span></span>`, 
              englishExplanation: "English: '减少' (jiǎn shǎo) means 'to reduce'. This aligns with the environmental goal of using fewer plastic bags." },
            { id: 'c2q16', question: "他在台上演讲时有些（ ），说话有点发抖。", options: ["紧张", "兴奋", "激动"], correctAnswer: "紧张", 
              explanation: "“紧张”(jǐn zhāng) 时，人会心跳加速，身体发抖。“兴奋”和“激动”是开心的情绪。", 
              annotatedSentence: `<span class="word-anno">演讲<span class="pinyin">yǎn jiǎng</span></span><span class="word-anno">时<span class="pinyin">shí</span></span><span class="word-anno">有些<span class="pinyin">yǒu xiē</span></span><span class="word-anno">紧张<span class="pinyin">jǐn zhāng</span></span>`, 
              englishExplanation: "English: '紧张' (jǐn zhāng) means 'nervous'. The clue '说话有点发抖' (speaking with a slight tremble) is a classic sign of nervousness." },
            { id: 'c2q17', question: "这次旅行，我们（ ）了很多美丽的照片。", options: ["拍摄", "拍照", "拍打"], correctAnswer: "拍摄", 
              explanation: "“拍摄”(pāi shè) 比“拍照”更正式，常用于描述摄影活动。“拍打”是用手或工具打。", 
              annotatedSentence: `<span class="word-anno">我们<span class="pinyin">wǒ men</span></span><span class="word-anno">拍摄<span class="pinyin">pāi shè</span></span><span class="word-anno">了<span class="pinyin">le</span></span><span class="word-anno">很多<span class="pinyin">hěn duō</span></span><span class="word-anno">美丽<span class="pinyin">měi lì</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">照片<span class="pinyin">zhào piàn</span></span>`, 
              englishExplanation: "English: '拍摄' (pāi shè) means 'to film' or 'to shoot (a photo)'. It's a more formal and fitting verb for taking many photos during a trip than the simple '拍照' (pāi zhào - take a picture)." },
            { id: 'c2q18', question: "他（ ）地捂住耳朵，不想听任何噪音。", options: ["迅速", "缓慢", "渐渐"], correctAnswer: "迅速", 
              explanation: "“迅速”(xùn sù) 意思是速度很快。这个词最符合捂住耳朵的动作。", 
              annotatedSentence: `<span class="word-anno">他<span class="pinyin">tā</span></span><span class="word-anno">迅速<span class="pinyin">xùn sù</span></span><span class="word-anno">地<span class="pinyin">de</span></span><span class="word-anno">捂住<span class="pinyin">wǔ zhù</span></span><span class="word-anno">耳朵<span class="pinyin">ěr duo</span></span>`, 
              englishExplanation: "English: '迅速' (xùn sù) means 'rapidly' or 'quickly'. This adverb best describes the reflex action of covering one's ears to block out noise." },
            { id: 'c2q19', question: "他为人（ ），从不和邻居发生争吵。", options: ["和祥", "慈祥", "祥和"], correctAnswer: "祥和", 
              explanation: "“祥和”(xiáng hé) 形容气氛或人的态度温和、安宁。“慈祥”多用来形容长辈。", 
              annotatedSentence: `<span class="word-anno">他<span class="pinyin">tā</span></span><span class="word-anno">为人<span class="pinyin">wéi rén</span></span><span class="word-anno">祥和<span class="pinyin">xiáng hé</span></span>`, 
              englishExplanation: "English: '祥和' (xiáng hé) describes a person's temperament as 'peaceful and serene'. This fits the clue that he never quarrels with neighbors. '慈祥' (cí xiáng - kindly) is usually for elders." },
            { id: 'c2q20', question: "面对困难，我们不能（ ）希望。", options: ["放弃", "放手", "放下"], correctAnswer: "放弃", 
              explanation: "“放弃”(fàng qì) 希望、机会或权利是固定搭配，意思是扔掉不要了。", 
              annotatedSentence: `<span class="word-anno">我们<span class="pinyin">wǒ men</span></span><span class="word-anno">不能<span class="pinyin">bù néng</span></span><span class="word-anno">放弃<span class="pinyin">fàng qì</span></span><span class="word-anno">希望<span class="pinyin">xī wàng</span></span>`, 
              englishExplanation: "English: '放弃' (fàng qì) means 'to give up'. The phrase '放弃希望' (fàng qì xī wàng - to give up hope) is a fixed expression." }
        ],
        "第三组：辨字与理解 (Hard)": [
            { id: 'c3q1', question: "弟弟不小心把邻居家的窗户（ ）破了。", options: ["杂", "砸", "匝"], correctAnswer: "砸", 
              explanation: "“砸”(zá) 是用重物撞击。“杂”(zá) 是多而乱的意思。", 
              annotatedSentence: `<span class="word-anno">把<span class="pinyin">bǎ</span></span><span class="word-anno">窗户<span class="pinyin">chuāng hu</span></span><span class="word-anno">砸<span class="pinyin">zá</span></span><span class="word-anno">破了<span class="pinyin">pò le</span></span>`, 
              englishExplanation: "English: The radical '石' (shí - stone) in '砸' (zá) suggests an action involving something hard. It means 'to smash'. The other characters don't fit." },
            { id: 'c3q2', question: "看到弟弟顽皮的（ ）子，妈妈又好气又好笑。", options: ["模", "摸", "膜"], correctAnswer: "模", 
              explanation: "“样子”(yàng zi) 是外貌或神情，也写作“模样”(mú yàng)。“摸”(mō) 是用手接触。", 
              annotatedSentence: `<span class="word-anno">顽皮的<span class="pinyin">wán pí de</span></span><span class="word-anno">模<span class="pinyin">mú</span></span><span class="word-anno">样<span class="pinyin">yàng</span></span>`, 
              englishExplanation: "English: The word for 'appearance' or 'look' is '模样' (mú yàng). '摸' (mō) means 'to touch', which doesn't make sense here." },
            { id: 'c3q3', question: "我们要分（ ）是非，做一个正直的人。", options: ["辨", "辩", "辫"], correctAnswer: "辨", 
              explanation: "“分辨”(fēn biàn) 是指区分辨别。“辩”是辩论(debate)， “辫”是辫子(braid)。", 
              annotatedSentence: `<span class="word-anno">分辨<span class="pinyin">fēn biàn</span></span><span class="word-anno">是非<span class="pinyin">shì fēi</span></span>`, 
              englishExplanation: "English: '分辨' (fēn biàn) means 'to distinguish' or 'to differentiate'. The character '辨' is used for telling things apart, like right from wrong ('是非')." },
            { id: 'c3q4', question: "虽然他家境不富裕，但他从不（ ）慕别人的生活。", options: ["羡", "嫌", "歉"], correctAnswer: "羡", 
              explanation: "“羡慕”(xiàn mù) 是看到别人有好的东西或条件而希望自己也有。“嫌”是嫌弃(dislike)。", 
              annotatedSentence: `<span class="word-anno">从不<span class="pinyin">cóng bù</span></span><span class="word-anno">羡<span class="pinyin">xiàn</span></span><span class="word-anno">慕<span class="pinyin">mù</span></span><span class="word-anno">别人<span class="pinyin">bié rén</span></span>`, 
              englishExplanation: "English: The word for 'to envy' or 'to admire' is '羡慕' (xiàn mù). '嫌' (xián) means 'to dislike', which is the opposite of the intended meaning." },
            { id: 'c3q5', question: "他（ ）着一股不服输的劲儿，刻苦练习，终于取得了进步。", options: ["凭", "任", "坪"], correctAnswer: "凭", 
              explanation: "“凭着”(píng zhe) 意思是依靠、根据。“任”是任由(let)。", 
              annotatedSentence: `<span class="word-anno">他<span class="pinyin">tā</span></span><span class="word-anno">凭<span class="pinyin">píng</span></span><span class="word-anno">着<span class="pinyin">zhe</span></span><span class="word-anno">一股<span class="pinyin">yī gǔ</span></span><span class="word-anno">不服输<span class="pinyin">bù fú shū</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">劲儿<span class="pinyin">jìnr</span></span>`, 
              englishExplanation: "English: '凭着' (píng zhe) means 'relying on' or 'by virtue of'. He achieved progress by relying on his never-give-up spirit." },
            { id: 'c3q6', question: "这次考试的范围很（ ），我们要好好复习。", options: ["广", "厂", "犷"], correctAnswer: "广", 
              explanation: "“广”(guǎng) 指范围大、多。“厂”是工厂(factory)。", 
              annotatedSentence: `<span class="word-anno">考试<span class="pinyin">kǎo shì</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">范围<span class="pinyin">fàn wéi</span></span><span class="word-anno">很<span class="pinyin">hěn</span></span><span class="word-anno">广<span class="pinyin">guǎng</span></span>`, 
              englishExplanation: "English: '广' (guǎng) means 'wide' or 'broad', and is used to describe the scope ('范围') of the exam. '厂' (chǎng) is factory." },
            { id: 'c3q7', question: "医生提醒我们要（ ）意饮食卫生，预防疾病。", options: ["注", "住", "柱"], correctAnswer: "注", 
              explanation: "“注意”(zhù yì) 是提醒要小心、留心。“住”是居住(live)。", 
              annotatedSentence: `<span class="word-anno">要<span class="pinyin">yào</span></span><span class="word-anno">注<span class="pinyin">zhù</span></span><span class="word-anno">意<span class="pinyin">yì</span></span><span class="word-anno">饮食<span class="pinyin">yǐn shí</span></span><span class="word-anno">卫生<span class="pinyin">wèi shēng</span></span>`, 
              englishExplanation: "English: The word for 'to pay attention to' is '注意' (zhù yì). It has a 'water' radical (氵). '住' (zhù) means 'to live'." },
            { id: 'c3q8', question: "妈妈把碗碟整齐地放进（ ）柜里。", options: ["厨", "橱", " chú"], correctAnswer: "橱", 
              explanation: "“橱柜”(chú guì) 是存放餐具的柜子，部首是“木”。而“厨房”(chú fáng)的“厨”部首是“厂”。", 
              annotatedSentence: `<span class="word-anno">放进<span class="pinyin">fàng jìn</span></span><span class="word-anno">橱<span class="pinyin">chú</span></span><span class="word-anno">柜<span class="pinyin">guì</span></span><span class="word-anno">里<span class="pinyin">lǐ</span></span>`, 
              englishExplanation: "English: A cabinet, '橱柜' (chú guì), is a piece of furniture, so '橱' has the 'wood' radical (木). The character for kitchen, '厨房' (chú fáng), uses '厨'." },
            { id: 'c3q9', question: "他因为在考试中作（ ），被取消了成绩。", options: ["弊", "币", "敝"], correctAnswer: "弊", 
              explanation: "“作弊”(zuò bì) 是指用不正当的手段在考试或比赛中取得好成绩。", 
              annotatedSentence: `<span class="word-anno">考试中<span class="pinyin">kǎo shì zhōng</span></span><span class="word-anno">作弊<span class="pinyin">zuò bì</span></span>`, 
              englishExplanation: "English: '作弊' (zuò bì) is the specific term for 'to cheat' in an exam. '币' (bì) means currency, and '敝' (bì) is a humble term for 'my'." },
            { id: 'c3q10', question: "我们要珍惜时间，不要（ ）费光阴。", options: ["浪", "良", "狼"], correctAnswer: "浪", 
              explanation: "“浪费”(làng fèi) 是指没有好好利用，使东西、时间等白白消耗掉。", 
              annotatedSentence: `<span class="word-anno">不要<span class="pinyin">bú yào</span></span><span class="word-anno">浪<span class="pinyin">làng</span></span><span class="word-anno">费<span class="pinyin">fèi</span></span><span class="word-anno">光阴<span class="pinyin">guāng yīn</span></span>`, 
              englishExplanation: "English: The word for 'to waste' is '浪费' (làng fèi). '光阴' (guāng yīn) is a literary term for 'time'." },
            { id: 'c3q11', question: "这件衣服的（ ）料很舒服，穿在身上很凉快。", options: ["材", "才", "财"], correctAnswer: "材", 
              explanation: "“材料”(cái liào) 是指制作物品的原料。", 
              annotatedSentence: `<span class="word-anno">衣服的<span class="pinyin">yī fu de</span></span><span class="word-anno">材<span class="pinyin">cái</span></span><span class="word-anno">料<span class="pinyin">liào</span></span><span class="word-anno">很<span class="pinyin">hěn</span></span><span class="word-anno">舒服<span class="pinyin">shū fu</span></span>`, 
              englishExplanation: "English: '材料' (cái liào) means 'material' or 'fabric'. The 'wood' radical (木) in '材' often relates to raw materials. '才' (cái) means talent, and '财' (cái) means wealth." },
            { id: 'c3q12', question: "这次华文测（ ）的成绩，我进步了很多。", options: ["捡", "验", "险"], correctAnswer: "验", 
              explanation: "“测验”(cè yàn) 是指考试、检查学习成果。", 
              annotatedSentence: `<span class="word-anno">华文<span class="pinyin">huá wén</span></span><span class="word-anno">测验<span class="pinyin">cè yàn</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">成绩<span class="pinyin">chéng jì</span></span>`, 
              englishExplanation: "English: '测验' (cè yàn) is the word for 'test' or 'quiz'. '验' (yàn) means to test or inspect. '捡' (jiǎn) is to pick up, and '险' (xiǎn) is danger." },
            { id: 'c3q13', question: "失败并不可怕，可怕的是失去（ ）斗的勇气。", options: ["奋", "愤", "份"], correctAnswer: "奋", 
              explanation: "“奋斗”(fèn dòu) 是指为了达到目的而努力。“愤”是愤怒(angry)。", 
              annotatedSentence: `<span class="word-anno">失去<span class="pinyin">shī qù</span></span><span class="word-anno">奋斗<span class="pinyin">fèn dòu</span></span><span class="word-anno">的<span class="pinyin">de</span></span><span class="word-anno">勇气<span class="pinyin">yǒng qì</span></span>`, 
              englishExplanation: "English: '奋斗' (fèn dòu) means 'to struggle' or 'to strive'. '奋' (fèn) itself carries the meaning of effort and exertion." },
            { id: 'c3q14', question: "我们要学会（ ）心等待，不要急躁。", options: ["耐", "奈", "nài"], correctAnswer: "耐", 
              explanation: "“耐心”(nài xīn) 是指不急躁、不厌烦的性格。", 
              annotatedSentence: `<span class="word-anno">学会<span class="pinyin">xué huì</span></span><span class="word-anno">耐<span class="pinyin">nài</span></span><span class="word-anno">心<span class="pinyin">xīn</span></span><span class="word-anno">等待<span class="pinyin">děng dài</span></span>`, 
              englishExplanation: "English: '耐心' (nài xīn) is the word for 'patience'. '耐' (nài) means to endure or to be patient." },
            { id: 'c3q15', question: "他（ ）决不向困难低头。", options: ["坚", "监", "艰"], correctAnswer: "坚", 
              explanation: "“坚决”(jiān jué) 表示态度、主张等非常坚定，不动摇。", 
              annotatedSentence: `<span class="word-anno">他<span class="pinyin">tā</span></span><span class="word-anno">坚<span class="pinyin">jiān</span></span><span class="word-anno">决<span class="pinyin">jué</span></span><span class="word-anno">不向<span class="pinyin">bú xiàng</span></span><span class="word-anno">困难<span class="pinyin">kùn nan</span></span><span class="word-anno">低头<span class="pinyin">dī tóu</span></span>`, 
              englishExplanation: "English: '坚决' (jiān jué) means 'resolute' or 'determined'. '坚' (jiān) means firm or solid." },
            { id: 'c3q16', question: "这道题的解题步（ ）很复杂。", options: ["骤", "聚", "取"], correctAnswer: "骤", 
              explanation: "“步骤”(bù zhòu) 是指做事情的先后次序。", 
              annotatedSentence: `<span class="word-anno">解题<span class="pinyin">jiě tí</span></span><span class="word-anno">步骤<span class="pinyin">bù zhòu</span></span><span class="word-anno">很<span class="pinyin">hěn</span></span><span class="word-anno">复杂<span class="pinyin">fù zá</span></span>`, 
              englishExplanation: "English: The word for 'steps' or 'procedure' is '步骤' (bù zhòu). '聚' (jù) means to gather, and '取' (qǔ) means to take." },
            { id: 'c3q17', question: "我军势如破竹，一（ ）千里，很快就取得了胜利。", options: ["泄", "泻", "卸"], correctAnswer: "泻", 
              explanation: "“一泻千里”(yī xiè qiān lǐ) 是一个成语，形容江河水流迅速，也比喻文笔或乐曲气势畅快。这里用“泻”。", 
              annotatedSentence: `<span class="word-anno">一泻千里<span class="pinyin">yī xiè qiān lǐ</span></span>`, 
              englishExplanation: "English: The idiom is '一泻千里' (yī xiè qiān lǐ), meaning 'to rush down a thousand miles'. It describes an unstoppable force. '泻' (xiè), with the water radical (氵), is used for flowing water." },
            { id: 'c3q18', question: "他不小心把墨水弄翻，（ ）脏了新买的白衬衫。", options: ["污", "亏", "于"], correctAnswer: "污", 
              explanation: "“污脏”(wū zāng) 意思是弄脏了。“亏”是吃亏，“于”是介词。", 
              annotatedSentence: `<span class="word-anno">污<span class="pinyin">wū</span></span><span class="word-anno">脏了<span class="pinyin">zāng le</span></span><span class="word-anno">新买的<span class="pinyin">xīn mǎi de</span></span><span class="word-anno">白衬衫<span class="pinyin">bái chèn shān</span></span>`, 
              englishExplanation: "English: '污' (wū) means 'to pollute' or 'to stain'. It is the correct character to describe making the shirt dirty ('脏')." },
            { id: 'c3q19', question: "他这个人很（ ）猾，你跟他打交道要小心。", options: ["狡", "较", "校"], correctAnswer: "狡", 
              explanation: "“狡猾”(jiǎo huá) 形容人诡计多端，不可信任。“较”是比较，“校”是学校。", 
              annotatedSentence: `<span class="word-anno">这个人<span class="pinyin">zhè ge rén</span></span><span class="word-anno">很<span class="pinyin">hěn</span></span><span class="word-anno">狡<span class="pinyin">jiǎo</span></span><span class="word-anno">猾<span class="pinyin">huá</span></span>`, 
              englishExplanation: "English: '狡猾' (jiǎo huá) is the word for 'cunning' or 'sly'. The 'dog' radical (犭) in '狡' often appears in characters related to animalistic or cunning traits." },
            { id: 'c3q20', question: "他设计的建筑（ ）式新颖，赢得了设计大奖。", options: ["格式", "方式", "式样"], correctAnswer: "式样", 
              explanation: "“式样”(shì yàng) 指的是物品的形状、外表。“格式”多指文件的布局，“方式”指方法。", 
              annotatedSentence: `<span class="word-anno">建筑<span class="pinyin">jiàn zhù</span></span><span class="word-anno">式样<span class="pinyin">shì yàng</span></span><span class="word-anno">新颖<span class="pinyin">xīn yǐng</span></span>`, 
              englishExplanation: "English: '式样' (shì yàng) means 'style' or 'design' (of an object). It's the best fit for describing the novel design of a building. '格式' (gé shì) is 'format' and '方式' (fāng shì) is 'method'." }
        ]
    };

    // --- State Variables ---
    let currentSetData = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let incorrectAnswers = [];
    let startTime;
    let endTime;
    let isRedoing = false;
    let proceedTimeoutId = null;
    let isWaitingToProceed = false;
    let userName = localStorage.getItem(USER_NAME_STORAGE_KEY) || '';

    // --- Sound Synthesis (Tone.js) ---
    const correctSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.2 }, }).toDestination();
    const incorrectSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();

    // --- Confetti ---
    const confettiCanvas = document.getElementById('confettiCanvas');
    const myConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });

    // --- DOM Elements ---
    const nameModal = document.getElementById('nameModal');
    const userNameInput = document.getElementById('userNameInput');
    const setSelectionScreen = document.getElementById('setSelectionScreen');
    const setButtonsContainer = document.getElementById('setButtonsContainer');
    const flashcardScreen = document.getElementById('flashcardScreen');
    const resultsScreen = document.getElementById('resultsScreen');
    const progressText = document.getElementById('progressText');
    const progressBarFill = document.getElementById('progressBarFill');
    const flashcard = document.getElementById('flashcard');
    const questionText = document.getElementById('questionText');
    const feedbackText = document.getElementById('feedbackText');
    const feedbackIconContainer = document.getElementById('feedbackIconContainer');
    const continueText = document.getElementById('continueText');
    const choiceButtons = [ document.getElementById('choice1'), document.getElementById('choice2'), document.getElementById('choice3') ];
    const scoreDisplayEl = document.getElementById('scoreDisplay');
    const percentageEl = document.getElementById('percentage');
    const timeTakenEl = document.getElementById('timeTaken');
    const incorrectListContainer = document.getElementById('incorrectListContainer');
    const incorrectList = document.getElementById('incorrectList');
    const noIncorrectText = document.getElementById('noIncorrectText');
    const redoIncorrectButton = document.getElementById('redoIncorrectButton');
    const encouragementTextEl = document.getElementById('encouragementText');
    const resultsHeadingEl = document.getElementById('resultsHeading');
    const raceTrackContainer = document.querySelector('#resultsScreen .race-track-container');
    const raceTrackFillEl = document.getElementById('raceTrackFill');
    const rocketEl = document.getElementById('rocketEl');

    // --- Event Listeners ---
    flashcard.addEventListener('click', () => {
        if (isWaitingToProceed &&
            !flashcard.classList.contains('incorrect-state') &&
            (flashcard.classList.contains('correct-state-static') || flashcard.classList.contains('clickable-card'))) {
            proceedToNext();
        }
    });
    userNameInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            saveUserName();
        }
    });

    // --- Utility Functions ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // --- Core Application Logic ---
    function populateStartButton() {
        setButtonsContainer.innerHTML = '';
        Object.keys(allFlashcardSets).forEach(setName => {
            const set = allFlashcardSets[setName];
            if (set.length >= QUESTIONS_PER_SET) {
                const button = document.createElement('button');
                button.textContent = `开始 ${setName}`;
                button.className = `action-button w-full py-4 px-6 bg-red-500 hover:bg-red-600 text-white mb-3 last:mb-0 text-lg`; 
                button.onclick = () => startFlashcardSession(set, setName);
                setButtonsContainer.appendChild(button);
            } else {
                const errorP = document.createElement('p');
                errorP.className = "text-red-500 text-sm";
                errorP.textContent = `Error: The set "${setName}" does not have enough questions (${set.length} found, ${QUESTIONS_PER_SET} required).`;
                setButtonsContainer.appendChild(errorP);
            }
        });
    }

    function saveUserName() {
        const name = userNameInput.value.trim();
        userName = name ? name : '学习者';
        localStorage.setItem(USER_NAME_STORAGE_KEY, userName);
        nameModal.style.display = 'none';
        showSetSelection();
    }

    function startFlashcardSession(selectedSet, setName) {
        Tone.start().catch(e => console.warn("Audio context could not start:", e));
        let fullSetCopy = [...selectedSet]; 
        shuffleArray(fullSetCopy);
        currentSetData = fullSetCopy.slice(0, QUESTIONS_PER_SET); 
        currentSetData.setName = setName; 
        currentQuestionIndex = 0;
        score = 0;
        incorrectAnswers = [];
        isRedoing = false;
        setSelectionScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        flashcardScreen.classList.remove('hidden');
        updateProgress(); 
        startTime = new Date();
        displayQuestion();
    }

    function resetCardState() {
        if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); proceedTimeoutId = null; }
        isWaitingToProceed = false;
        flashcard.classList.remove('shake', 'correct-state-static', 'incorrect-state', 'clickable-card');
        questionText.classList.remove('hidden');
        feedbackText.innerHTML = '';
        feedbackIconContainer.classList.add('hidden');
        continueText.classList.add('hidden');
        choiceButtons.forEach(btn => {
            btn.className = 'choice-button bg-slate-100 hover:bg-slate-200 text-slate-700';
        });
    }

    function displayQuestion() {
        resetCardState();
        if (currentQuestionIndex >= currentSetData.length) {
            showResults();
            return;
        }
        const questionData = currentSetData[currentQuestionIndex];
        questionText.innerHTML = questionData.question.replace(/\n/g, '<br>');
        let displayOptions = [...questionData.options];
        shuffleArray(displayOptions);
        choiceButtons.forEach((button, index) => {
            if (displayOptions[index] !== undefined) {
                button.textContent = displayOptions[index];
                button.disabled = false;
                button.dataset.answer = displayOptions[index];
                button.onclick = () => checkAnswer(button);
                button.style.display = 'flex';
            } else {
                button.style.display = 'none'; 
            }
        });
    }

    function updateProgress() {
        const totalQuestions = currentSetData.length;
        const completed = currentQuestionIndex;
        const progressPercentage = totalQuestions > 0 ? (completed / totalQuestions) * 100 : 0;
        progressText.textContent = `${completed} / ${totalQuestions}`;
        progressBarFill.style.width = `${progressPercentage}%`;
    }

    function checkAnswer(button) {
        Tone.start().catch(e => console.warn("Audio context failed:", e));
        if (isWaitingToProceed && !flashcard.classList.contains('incorrect-state')) return;
        const selectedAnswer = button.dataset.answer;
        const questionData = currentSetData[currentQuestionIndex];
        const correctAnswer = questionData.correctAnswer;
        choiceButtons.forEach(btn => btn.disabled = true);

        if (selectedAnswer === correctAnswer) {
            if (!isRedoing) score++;
            flashcard.classList.add('correct-state-static');
            feedbackIconContainer.innerHTML = '<span class="text-7xl md:text-8xl">✓</span>';
            feedbackIconContainer.classList.remove('hidden');
            questionText.classList.add('hidden');
            feedbackText.textContent = '正确!';
            myConfetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
            correctSound.triggerAttackRelease("G5", "8n", Tone.now());
            button.className = 'choice-button bg-emerald-600 text-white ring-2 ring-emerald-800 shadow-md';
            isWaitingToProceed = true;
            flashcard.classList.add('clickable-card');
            continueText.classList.remove('hidden');
            proceedTimeoutId = setTimeout(proceedToNext, AUTO_PROCEED_DELAY);
            currentQuestionIndex++; 
            updateProgress(); 
        } else {
            flashcard.classList.add('shake', 'incorrect-state');
            feedbackIconContainer.innerHTML = '<span class="text-7xl md:text-8xl">✗</span>';
            feedbackIconContainer.classList.remove('hidden');
            questionText.classList.add('hidden'); 
            
            // NEW: Enhanced feedback generation
            const annotatedSentence = questionData.annotatedSentence.replace('（ ）', `<span class="word-anno" style="color:#ffb703;">${correctAnswer}<span class="pinyin"> </span></span>`);
            const englishExplanation = questionData.englishExplanation || "";
            const chineseExplanation = questionData.explanation || "没有解析。";
            
            feedbackText.innerHTML = `
                <div class="annotated-sentence-container">${annotatedSentence}</div>
                <div class="english-explanation">${englishExplanation}</div>
                <div class="explanation-box"><b>中文解析:</b> ${chineseExplanation}</div>
                <div class="prompt-guidance">点击绿色正确答案继续。</div>
            `;

            incorrectSound.triggerAttackRelease("C3", "8n");
            if (!isRedoing) {
                incorrectAnswers.push({ questionData: questionData, userAnswer: selectedAnswer });
            }
            isWaitingToProceed = false;
            flashcard.classList.remove('clickable-card');
            if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); }
            choiceButtons.forEach(btn => {
                if (btn.dataset.answer === correctAnswer) {
                    btn.className = 'choice-button bg-emerald-500 hover:bg-emerald-600 text-white';
                    btn.disabled = false;
                    btn.onclick = function() {
                        currentQuestionIndex++; 
                        updateProgress(); 
                        proceedToNext();
                    };
                } else if (btn === button) {
                    btn.className = 'choice-button bg-red-700 text-white ring-2 ring-red-900 shadow-md';
                } else {
                    btn.className = 'choice-button bg-slate-200 text-slate-500 forced-disabled-look';
                }
            });
        }
    }

    function proceedToNext() {
        if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); }
        isWaitingToProceed = false;
        displayQuestion();
    }

    function showResults() {
        endTime = new Date();
        const timeDiff = Math.round((endTime - startTime) / 1000);
        const totalQuestions = currentSetData.length;
        const currentScore = isRedoing ? (totalQuestions - incorrectAnswers.length) : score;
        const percentage = totalQuestions > 0 ? Math.round((currentScore / totalQuestions) * 100) : 0;

        resultsHeadingEl.textContent = isRedoing ? '错题复习完成！' : `“${currentSetData.setName || '练习'}”完成!`;
        scoreDisplayEl.textContent = `${currentScore} / ${totalQuestions}`;
        percentageEl.textContent = `${percentage}`;
        timeTakenEl.textContent = `${timeDiff}`;

        if (percentage === 100) encouragementTextEl.textContent = "太棒了，满分！你已经掌握了这个部分！";
        else if (percentage >= 70) encouragementTextEl.textContent = "做得很好！继续努力，你非常出色。";
        else encouragementTextEl.textContent = "不错！复习一下错题，可以让你更强大。";
        
        flashcardScreen.classList.add('hidden');
        resultsScreen.classList.remove('hidden');
        
        requestAnimationFrame(() => {
            setTimeout(() => { 
                const trackWidth = raceTrackContainer.offsetWidth;
                const effectiveTrackWidth = trackWidth - rocketEl.offsetWidth; 
                const finalRocketPosition = Math.max(0, (percentage / 100) * effectiveTrackWidth);
                rocketEl.style.left = `${finalRocketPosition}px`;
                raceTrackFillEl.style.width = `${finalRocketPosition}px`;
            }, 100);
        });

        incorrectList.innerHTML = '';
        if (incorrectAnswers.length > 0) {
            incorrectListContainer.classList.remove('hidden'); noIncorrectText.classList.add('hidden');
            incorrectAnswers.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<b>问题:</b> ${item.questionData.question.replace(/\n/g, ' ')}<br/><b>你的答案:</b> <span class="text-red-500">${item.userAnswer}</span><br/><b>正确答案:</b> <span class="text-emerald-600">${item.questionData.correctAnswer}</span>`;
                incorrectList.appendChild(li);
            });
            redoIncorrectButton.classList.remove('hidden');
            redoIncorrectButton.disabled = isRedoing || incorrectAnswers.length === 0;
        } else {
            incorrectListContainer.classList.add('hidden'); noIncorrectText.classList.remove('hidden');
            redoIncorrectButton.classList.add('hidden');
        }

        sendResultsToGoogleSheet({
            setName: currentSetData.setName || "Unknown Set", score: currentScore, totalQuestions: totalQuestions,
            percentage: percentage, timeTaken: timeDiff,
            incorrectAnswersJSON: JSON.stringify(incorrectAnswers.map(item => ({ q: item.questionData.question, u: item.userAnswer, c: item.questionData.correctAnswer }))),
            name: userName, timestamp: new Date().toISOString() 
        });

        if (isRedoing) { incorrectAnswers = []; isRedoing = false; }
    }

    function sendResultsToGoogleSheet(data) {
        fetch(APPS_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({payloadType: 'flashcardResults', ...data, subject: 'Chinese' })
        }).catch(err => console.error("Failed to send results:", err));
    }

    function redoIncorrect() {
        if (incorrectAnswers.length === 0) return;
        const originalSetName = currentSetData.setName.replace(" (重做)", "");
        currentSetData = incorrectAnswers.map(item => item.questionData);
        currentSetData.setName = `${originalSetName} (重做)`;
        currentQuestionIndex = 0;
        incorrectAnswers = []; 
        isRedoing = true;
        resultsScreen.classList.add('hidden');
        flashcardScreen.classList.remove('hidden');
        startTime = new Date();
        updateProgress(); 
        displayQuestion();
    }

    function showSetSelection() {
        if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); }
        isWaitingToProceed = false; isRedoing = false; 
        nameModal.style.display = 'none';
        flashcardScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        setSelectionScreen.classList.remove('hidden');
        populateStartButton();
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        userName = localStorage.getItem(USER_NAME_STORAGE_KEY) || '';
        if (userName) {
            showSetSelection(); 
        } else {
            nameModal.style.display = 'flex';
            userNameInput.focus();
        }
    });
</script>

</body>
</html>
